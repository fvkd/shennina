#!/usr/bin/env python3
import os
import sys
PATH = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(PATH)
import config

_port_to_exploits_cache = None


def _get_port_to_exploits_map():
    global _port_to_exploits_cache
    if _port_to_exploits_cache is None:
        _port_to_exploits_cache = {}
        # Ensure EXPLOITS_TREE is loaded
        exploits_tree = config.get_exploits_tree()
        for exploit in exploits_tree:
            port = str(exploit.get("default_port"))
            if port not in _port_to_exploits_cache:
                _port_to_exploits_cache[port] = []

            # Pre-lower platforms for faster matching and avoid repeated lower() calls
            exploit_copy = exploit.copy()
            exploit_copy["platforms_lower"] = [p.lower() for p in exploit.get("platform", [])]
            _port_to_exploits_cache[port].append(exploit_copy)
    return _port_to_exploits_cache


def map_port_to_exploits(port_number, platform):
    output = []
    if platform == "microsoft":
        platform = "windows"
    current_platforms = [platform]
    if platform == "linux":
        current_platforms.append("unix")
    elif platform == "unix":
        current_platforms.append("linux")

    port_map = _get_port_to_exploits_map()
    relevant_exploits = port_map.get(str(port_number), [])

    for exploit in relevant_exploits:
        for supported_platform_lower in exploit["platforms_lower"]:
            for current_platform in current_platforms:
                if current_platform in supported_platform_lower:
                    output.append(exploit["exploit"])
    return output
